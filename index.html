<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width,
               initial-scale=1,
               maximum-scale=1,
               user-scalable=no">
<title>Jump Cube - –•–ê–†–î–ö–û–†</title>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  background: linear-gradient(180deg, #0a1418, #15252d, #1c3a47);
  overflow: hidden;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  touch-action: manipulation;
  color: #fff;
  -webkit-tap-highlight-color: transparent;
}

#gameWrapper {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

canvas {
  display: block;
  background: transparent;
}

/* UI */
.ui {
  position: fixed;
  top: max(12px, env(safe-area-inset-top, 12px));
  left: 12px;
  right: 12px;
  display: flex;
  justify-content: space-between;
  pointer-events: none;
  z-index: 10;
}

.panel {
  pointer-events: auto;
  background: rgba(0,0,0,.6);
  padding: 12px 16px;
  border-radius: 16px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,50,50,0.3);
  font-weight: 700;
  min-width: 120px;
  box-shadow: 0 4px 12px rgba(255,0,0,0.2);
}

#scorePanel {
  text-align: left;
}

#controlPanel {
  text-align: right;
}

button, select {
  border: none;
  border-radius: 14px;
  padding: 12px 18px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
  background: linear-gradient(135deg, #ff4757, #ff3838);
  color: white;
  min-width: 120px;
  border: 2px solid rgba(255,255,255,0.3);
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}

button:active {
  transform: scale(0.95);
}

button:hover {
  box-shadow: 0 0 25px rgba(255, 71, 87, 0.6);
}

#jumpBtn {
  position: fixed;
  bottom: max(24px, env(safe-area-inset-bottom, 24px));
  left: 50%;
  transform: translateX(-50%);
  font-size: 26px;
  padding: 28px 90px;
  z-index: 10;
  box-shadow: 0 10px 40px rgba(255,0,0,0.4);
  border: 3px solid rgba(255,255,255,0.3);
  font-weight: 800;
  letter-spacing: 1px;
  background: linear-gradient(135deg, #ff3838, #ff0000);
}

/* Pause menu */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.9);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 100;
  animation: fadeIn 0.3s ease;
}

.menu {
  background: linear-gradient(135deg, rgba(28, 0, 0, 0.95), rgba(70, 0, 0, 0.95));
  padding: 32px;
  border-radius: 24px;
  text-align: center;
  min-width: 320px;
  max-width: 90vw;
  border: 2px solid rgba(255, 50, 50, 0.5);
  box-shadow: 0 25px 70px rgba(255,0,0,0.3);
  animation: slideUp 0.4s ease;
}

.menu h2 {
  margin-top: 0;
  color: #ff4757;
  font-size: 32px;
  text-shadow: 0 2px 10px rgba(255,0,0,0.5);
}

.menu select {
  width: 100%;
  margin: 8px 0;
  background: rgba(0,0,0,0.5);
  color: white;
  border: 2px solid rgba(255,50,50,0.5);
  font-weight: 600;
}

/* Game over overlay */
#gameOverMenu {
  display: none;
}

#finalScore {
  font-size: 52px;
  font-weight: 900;
  color: #ff3838;
  margin: 20px 0;
  text-shadow: 0 0 20px rgba(255,0,0,0.7);
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { transform: translateY(40px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

.score-animation {
  animation: pulse 0.2s ease, shake 0.3s ease;
}

/* Difficulty warning */
.difficulty-warning {
  color: #ff4757;
  font-size: 12px;
  margin-top: 5px;
  font-weight: 700;
}

/* Screenshake */
.shake {
  animation: shake 0.5s ease;
}

/* Speed warning */
#speedWarning {
  position: fixed;
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255, 0, 0, 0.8);
  padding: 10px 20px;
  border-radius: 10px;
  display: none;
  font-weight: 700;
  z-index: 20;
}

/* Instructions */
#instructions {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  background: rgba(0,0,0,0.85);
  padding: 25px;
  border-radius: 20px;
  backdrop-filter: blur(10px);
  display: none;
  z-index: 50;
  border: 2px solid #ff4757;
  max-width: 400px;
}

#instructions h3 {
  color: #ff4757;
  font-size: 24px;
}

/* Particles */
.particle {
  position: absolute;
  pointer-events: none;
  z-index: 1;
}

/* Combo indicator */
#combo {
  position: fixed;
  top: 150px;
  right: 20px;
  font-size: 24px;
  font-weight: 900;
  color: #ff4757;
  text-shadow: 0 0 10px rgba(255,0,0,0.5);
  display: none;
  z-index: 15;
}
</style>
</head>

<body>

<div id="gameWrapper">
  <canvas id="canvas"></canvas>
</div>

<!-- Particles container -->
<div id="particles"></div>

<!-- Game UI -->
<div class="ui">
  <div id="scorePanel" class="panel">
    <div>–û–ß–ö–ò: <span id="score">0</span></div>
    <div>–†–ï–ö–û–†–î: <span id="best">0</span></div>
    <div id="speedDisplay">–°–ö–û–†–û–°–¢–¨: <span id="speedValue">1.0x</span></div>
  </div>
  <div id="controlPanel" class="panel">
    <button id="pauseBtn">‚è∏ –ü–ê–£–ó–ê</button>
  </div>
</div>

<!-- Combo display -->
<div id="combo"></div>

<!-- Speed warning -->
<div id="speedWarning">–í–ù–ò–ú–ê–ù–ò–ï! –í–´–°–û–ö–ê–Ø –°–ö–û–†–û–°–¢–¨!</div>

<button id="jumpBtn">–ü–†–´–ñ–û–ö!</button>

<!-- Pause Menu -->
<div id="pauseMenu" class="overlay">
  <div class="menu">
    <h2>–ü–ê–£–ó–ê</h2>

    <div>
      <label>–°–õ–û–ñ–ù–û–°–¢–¨:</label><br>
      <select id="difficulty">
        <option value="hard">–•–ê–†–î (–±–∞–∑–æ–≤–∞—è)</option>
        <option value="extreme" selected>–≠–ö–°–¢–†–ò–ú +25%</option>
        <option value="nightmare">–ö–û–®–ú–ê–† +50%</option>
        <option value="impossible">–ù–ï–í–û–ó–ú–û–ñ–ù–û +100%</option>
      </select>
      <div class="difficulty-warning" id="difficultyWarning"></div>
    </div><br>

    <div>
      <label>–†–ï–ñ–ò–ú:</label><br>
      <select id="mode">
        <option value="classic">–ö–õ–ê–°–°–ò–ö–ê</option>
        <option value="gravityChaos">–•–ê–û–° –ì–†–ê–í–ò–¢–ê–¶–ò–ò</option>
        <option value="speedRush">–°–ö–û–†–û–°–¢–ù–û–ô –†–ï–ñ–ò–ú</option>
        <option value="narrowPlatforms">–£–ó–ö–ò–ï –ü–õ–ê–¢–§–û–†–ú–´</option>
        <option value="movingPlatforms">–î–í–ò–ñ–£–©–ò–ï–°–Ø –ü–õ–ê–¢–§–û–†–ú–´</option>
      </select>
    </div><br>

    <button onclick="togglePause()">‚ñ∂ –ü–†–û–î–û–õ–ñ–ò–¢–¨</button><br><br>
    <button onclick="restartGame()">üî• –ù–ê–ß–ê–¢–¨ –ó–ê–ù–û–í–û</button><br><br>
    <button onclick="resetBestScore()">üóëÔ∏è –°–ë–†–û–°–ò–¢–¨ –†–ï–ö–û–†–î</button>
  </div>
</div>

<!-- Game Over Menu -->
<div id="gameOverMenu" class="overlay">
  <div class="menu">
    <h2>–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê!</h2>
    <div id="finalScore">0</div>
    <div>–õ–£–ß–®–ò–ô: <span id="bestScoreDisplay">0</span></div>
    <div id="deathMessage"></div><br>
    <button onclick="startNewGame()">üíÄ –ù–û–í–ê–Ø –ò–ì–†–ê</button><br><br>
    <button onclick="showPauseMenu()">‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò</button>
  </div>
</div>

<!-- Instructions -->
<div id="instructions">
  <h3>–í–ù–ò–ú–ê–ù–ò–ï: –•–ê–†–î–ö–û–† –†–ï–ñ–ò–ú</h3>
  <p>–°–ª–æ–∂–Ω–æ—Å—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–∞ –Ω–∞ 25%!</p>
  <p>‚Ä¢ –í—ã—Å–æ–∫–∞—è –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—è</p>
  <p>‚Ä¢ –ë—ã—Å—Ç—Ä—ã–π —Ä–æ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏</p>
  <p>‚Ä¢ –ú–µ–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Ä–µ–∞–∫—Ü–∏—é</p>
  <p>‚Ä¢ –£–∑–∫–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</p>
  <p>–£–¥–∞—á–∏, —Ç–µ–±–µ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è!</p>
  <button onclick="hideInstructions()">–ü–†–ò–ù–Ø–¢–¨ –í–´–ó–û–í!</button>
</div>

<script>
/* ================= GAME RESOLUTION ================= */
const GAME_WIDTH  = 390;
const GAME_HEIGHT = 844;

/* ================= DIFFICULTIES ================= */
const DIFFICULTIES = {
  hard: {
    jump: 15,
    gravity: 1.0,
    speedGrowth: 0.008,
    baseSpeed: 3.5
  },
  extreme: {
    jump: 14,
    gravity: 1.2,
    speedGrowth: 0.01,
    baseSpeed: 4.0
  },
  nightmare: {
    jump: 13,
    gravity: 1.5,
    speedGrowth: 0.013,
    baseSpeed: 4.5
  },
  impossible: {
    jump: 12,
    gravity: 1.8,
    speedGrowth: 0.016,
    baseSpeed: 5.0
  }
};

/* ================= CANVAS SETUP ================= */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let scale = 1;

function resize() {
  const dpr = window.devicePixelRatio || 1;
  const sw = window.innerWidth;
  const sh = window.innerHeight;

  scale = Math.min(sw / GAME_WIDTH, sh / GAME_HEIGHT);

  canvas.style.width  = GAME_WIDTH * scale + 'px';
  canvas.style.height = GAME_HEIGHT * scale + 'px';
  canvas.width  = Math.floor(GAME_WIDTH * dpr);
  canvas.height = Math.floor(GAME_HEIGHT * dpr);

  ctx.scale(dpr, dpr);
}
resize();
window.addEventListener('resize', resize);

/* ================= GAME STATE ================= */
const groundY = GAME_HEIGHT * 0.55;

const cube = {
  x: 70,
  y: groundY - 60,
  size: 36,
  vy: 0,
  grounded: false,
  color: '#ff4757',
  trail: []
};

let platforms = [];
let particles = [];
let speed = 0;
let score = 0;
let combo = 0;
let comboTimeout = null;
let bestScore = 0;
let paused = false;
let gameOver = false;
let config = DIFFICULTIES.extreme; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≠–ö–°–¢–†–ò–ú
let mode = 'classic';
let screenShake = 0;
let lastPlatformY = groundY;

/* ================= DOM ELEMENTS ================= */
const scoreEl = document.getElementById('score');
const bestEl = document.getElementById('best');
const speedValue = document.getElementById('speedValue');
const speedWarning = document.getElementById('speedWarning');
const pauseMenu = document.getElementById('pauseMenu');
const gameOverMenu = document.getElementById('gameOverMenu');
const finalScoreEl = document.getElementById('finalScore');
const bestScoreDisplay = document.getElementById('bestScoreDisplay');
const deathMessage = document.getElementById('deathMessage');
const difficultyWarning = document.getElementById('difficultyWarning');
const instructions = document.getElementById('instructions');
const jumpBtn = document.getElementById('jumpBtn');
const pauseBtn = document.getElementById('pauseBtn');
const difficultySelect = document.getElementById('difficulty');
const modeSelect = document.getElementById('mode');
const comboEl = document.getElementById('combo');

/* ================= INITIALIZATION ================= */
function init() {
  // Load best score
  bestScore = Number(localStorage.getItem('jumpCubeHardBestScore')) || 0;
  bestEl.textContent = bestScore;
  bestScoreDisplay.textContent = bestScore;

  // Set difficulty warning
  updateDifficultyWarning();

  // Show instructions
  setTimeout(() => {
    instructions.style.display = 'block';
  }, 500);

  initPlatforms();
  startGameLoop();
}

/* ================= PLATFORMS ================= */
function initPlatforms() {
  platforms = [{
    x: 0,
    y: groundY,
    width: 240,
    height: 20,
    color: '#ff4757',
    moving: false,
    moveSpeed: 0,
    direction: 1,
    landed: false
  }];

  lastPlatformY = groundY;

  // Generate initial platforms
  for (let i = 0; i < 6; i++) {
    addPlatform();
  }
}

function addPlatform() {
  const last = platforms.at(-1);
  const platformColors = ['#ff4757', '#ff3838', '#ff0000', '#ff6b6b'];

  // –°–ª—É—á–∞–π–Ω–∞—è –≤—ã—Å–æ—Ç–∞ (–±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è)
  let newY;
  if (mode === 'narrowPlatforms') {
    newY = clamp(lastPlatformY + rand(-120, 120), groundY - 200, groundY + 200);
  } else {
    newY = clamp(lastPlatformY + rand(-100, 100), groundY - 180, groundY + 180);
  }
  lastPlatformY = newY;

  // –®–∏—Ä–∏–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
  let width;
  if (mode === 'narrowPlatforms') {
    width = rand(80, 120); // –£–∂–µ –æ–±—ã—á–Ω–æ–≥–æ
  } else {
    width = rand(90, 140); // –£–∂–µ –Ω–∞ 25%
  }

  const newPlatform = {
    x: last.x + last.width + 70 + speed * 12,
    y: newY,
    width: width,
    height: 18,
    color: platformColors[Math.floor(Math.random() * platformColors.length)],
    landed: false
  };

  // –î–≤–∏–∂—É—â–∏–µ—Å—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
  if (mode === 'movingPlatforms' && Math.random() > 0.5) {
    newPlatform.moving = true;
    newPlatform.moveSpeed = rand(1, 2);
    newPlatform.direction = Math.random() > 0.5 ? 1 : -1;
  }

  platforms.push(newPlatform);
}

/* ================= PARTICLES ================= */
function createParticles(x, y, count, color) {
  for (let i = 0; i < count; i++) {
    particles.push({
      x: x,
      y: y,
      vx: rand(-4, 4),
      vy: rand(-6, -3),
      size: rand(2, 6),
      color: color || '#ff4757',
      life: 1.0,
      decay: rand(0.03, 0.07)
    });
  }
}

function updateParticles() {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.15;
    p.life -= p.decay;

    if (p.life <= 0) {
      particles.splice(i, 1);
    }
  }
}

function drawParticles() {
  particles.forEach(p => {
    ctx.globalAlpha = p.life;
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x, p.y, p.size, p.size);
  });
  ctx.globalAlpha = 1.0;
}

/* ================= COMBO SYSTEM ================= */
function addCombo() {
  combo++;
  if (combo > 1) {
    comboEl.style.display = 'block';
    comboEl.textContent = `COMBO x${combo}!`;
    comboEl.style.fontSize = 20 + combo * 2 + 'px';

    // –ê–Ω–∏–º–∞—Ü–∏—è
    comboEl.style.animation = 'pulse 0.3s ease';
    setTimeout(() => {
      comboEl.style.animation = '';
    }, 300);

    // –ë–æ–Ω—É—Å–Ω—ã–µ –æ—á–∫–∏ –∑–∞ –∫–æ–º–±–æ
    if (combo >= 3) {
      score += Math.floor(combo / 3);
      scoreEl.textContent = score;
      scoreEl.classList.add('score-animation');
      setTimeout(() => {
        scoreEl.classList.remove('score-animation');
      }, 300);
    }
  }

  clearTimeout(comboTimeout);
  comboTimeout = setTimeout(() => {
    combo = 0;
    comboEl.style.display = 'none';
  }, 2000);
}

/* ================= INPUT HANDLING ================= */
function jump() {
  if (gameOver) {
    startNewGame();
    return;
  }

  if (!paused && cube.grounded) {
    cube.vy = -config.jump;
    cube.grounded = false;

    // –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü
    createParticles(
      cube.x + cube.size / 2,
      cube.y + cube.size,
      10,
      cube.color
    );

    // –î–æ–±–∞–≤–∏—Ç—å –≤ —Ç—Ä–µ–π–ª
    cube.trail.push({x: cube.x, y: cube.y, life: 1.0});
    if (cube.trail.length > 8) cube.trail.shift();

    // –≠—Ñ—Ñ–µ–∫—Ç –∫–Ω–æ–ø–∫–∏
    jumpBtn.style.animation = 'pulse 0.15s ease';
    setTimeout(() => {
      jumpBtn.style.animation = '';
    }, 150);

    // –°–∫—Ä–∏–Ω—à–µ–π–∫ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º –∫–æ–º–±–æ
    if (combo >= 5) {
      screenShake = 5;
    }
  }
}

// Button events
jumpBtn.addEventListener('click', jump);
jumpBtn.addEventListener('touchstart', e => {
  e.preventDefault();
  jump();
}, { passive: false });

pauseBtn.addEventListener('click', togglePause);

// Keyboard controls
document.addEventListener('keydown', e => {
  if (e.code === 'Space' || e.key === ' ' || e.key === 'ArrowUp') {
    e.preventDefault();
    jump();
  } else if (e.key === 'Escape' || e.key === 'Pause') {
    togglePause();
  }
});

// Touch controls
let touchStartY = 0;
document.addEventListener('touchstart', e => {
  if (!e.target.closest('button') && !e.target.closest('select')) {
    e.preventDefault();
    touchStartY = e.touches[0].clientY;
  }
}, { passive: false });

document.addEventListener('touchend', e => {
  if (!e.target.closest('button') && !e.target.closest('select')) {
    e.preventDefault();
    jump();
  }
}, { passive: false });

/* ================= GAME MENUS ================= */
function togglePause() {
  if (gameOver) return;

  paused = !paused;
  pauseMenu.style.display = paused ? 'flex' : 'none';

  if (!paused) {
    updateConfig();
  }
}

function showPauseMenu() {
  gameOverMenu.style.display = 'none';
  pauseMenu.style.display = 'flex';
  paused = true;
}

function showGameOver() {
  gameOver = true;
  paused = true;

  finalScoreEl.textContent = score;
  bestScoreDisplay.textContent = bestScore;

  // –°–ª—É—á–∞–π–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Å–º–µ—Ä—Ç–∏
  const messages = [
    "–°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–±–µ–∂–¥–∞–µ—Ç!",
    "–°–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ!",
    "–ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è –∂–µ—Å—Ç–æ–∫–∞!",
    "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!",
    "–¢—ã –±—ã–ª –±–ª–∏–∑–æ–∫!",
    "–°–∫–æ—Ä–æ—Å—Ç—å —É–±–∏–≤–∞–µ—Ç!",
    "–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –ø—Ä–∞–∫—Ç–∏–∫–∏!",
    "–•–∞—Ä–¥–∫–æ—Ä - —ç—Ç–æ —Å–ª–æ–∂–Ω–æ!"
  ];
  deathMessage.textContent = messages[Math.floor(Math.random() * messages.length)];

  gameOverMenu.style.display = 'flex';

  // –≠—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–æ–∏–≥—Ä—ã—à–∞
  for (let i = 0; i < 80; i++) {
    createParticles(
      cube.x + cube.size / 2,
      cube.y + cube.size / 2,
      1,
      ['#ff4757', '#ff0000', '#ff3838'][Math.floor(Math.random() * 3)]
    );
  }
}

function updateConfig() {
  config = DIFFICULTIES[difficultySelect.value];
  mode = modeSelect.value;
  updateDifficultyWarning();
}

function updateDifficultyWarning() {
  const warnings = {
    hard: "–°–ª–æ–∂–Ω–æ—Å—Ç—å: +25% –æ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π",
    extreme: "–í–ù–ò–ú–ê–ù–ò–ï: +25% –æ—Ç –•–ê–†–î–ê!",
    nightmare: "–û–°–¢–û–†–û–ñ–ù–û: +50% –æ—Ç –•–ê–†–î–ê!",
    impossible: "–ë–ï–ó–£–ú–ò–ï: +100% –æ—Ç –•–ê–†–î–ê!"
  };
  difficultyWarning.textContent = warnings[difficultySelect.value];
}

function hideInstructions() {
  instructions.style.display = 'none';
  if (paused) {
    togglePause();
  }
}

function resetBestScore() {
  if (confirm("–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å —Ä–µ–∫–æ—Ä–¥?")) {
    bestScore = 0;
    bestEl.textContent = '0';
    bestScoreDisplay.textContent = '0';
    localStorage.setItem('jumpCubeHardBestScore', '0');
  }
}

/* ================= GAME LOGIC ================= */
function update() {
  if (paused || gameOver) return;

  updateParticles();
  updateCubeTrail();

  // –†–µ–∂–∏–º—ã –∏–≥—Ä—ã
  let currentGravity = config.gravity;
  let speedMultiplier = 1;

  switch (mode) {
    case 'gravityChaos':
      currentGravity += rand(-0.15, 0.5);
      cube.color = ['#ff4757', '#ffa502', '#2ed573'][Math.floor(Date.now()/200)%3];
      break;
    case 'speedRush':
      speedMultiplier = 2.0;
      if (speed * speedMultiplier > 8) {
        speedWarning.style.display = 'block';
      }
      break;
    case 'narrowPlatforms':
      // –£–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º
      break;
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É–±–∞
  cube.vy += currentGravity;
  cube.vy = Math.min(cube.vy, 12); // –ª–∏–º–∏—Ç –ø–∞–¥–µ–Ω–∏—è
  cube.y += cube.vy;
  cube.grounded = false;

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–π–ª–∞
  cube.trail.forEach(t => t.life -= 0.02);
  cube.trail = cube.trail.filter(t => t.life > 0);

  // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏
  let landedThisFrame = false;
  for (const p of platforms) {
    // –î–≤–∏–∂–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º
    if (p.moving) {
      p.y += p.moveSpeed * p.direction;
      if (p.y < groundY - 250 || p.y > groundY + 250) {
        p.direction *= -1;
      }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
    if (
      cube.vy >= 0 &&
      cube.x + cube.size > p.x &&
      cube.x < p.x + p.width &&
      cube.y + cube.size >= p.y &&
      cube.y + cube.size <= p.y + p.height
    ) {
      cube.y = p.y - cube.size;
      cube.vy = 0;
      cube.grounded = true;
      landedThisFrame = true;
      
      // –≠—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏–∑–µ–º–ª–µ–Ω–∏—è
      if (!p.landed) {
        createParticles(cube.x + cube.size / 2, cube.y + cube.size, 8, p.color);
        addCombo();
        p.landed = true;

        // –°–∫—Ä–∏–Ω—à–µ–π–∫ –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º –ø–∞–¥–µ–Ω–∏–∏
        if (cube.vy > 15) {
          screenShake = 3;
        }
      }
    } else {
      if (p.landed) p.landed = false;
    }
  }

  // –°–±—Ä–æ—Å –∫–æ–º–±–æ –µ—Å–ª–∏ –Ω–µ –ø—Ä–∏–∑–µ–º–ª–∏–ª—Å—è
  if (!landedThisFrame && combo > 0) {
    combo = 0;
    comboEl.style.display = 'none';
  }

  // –î–≤–∏–∂–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º
  platforms.forEach(p => p.x -= speed * speedMultiplier);

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º
  if (platforms.at(-1).x < GAME_WIDTH - 80) {
    addPlatform();
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º
  if (platforms[0].x + platforms[0].width < 0) {
    platforms.shift();
    score++;
    scoreEl.textContent = score;
    scoreEl.classList.add('score-animation');

    // –ß–∞—Å—Ç–∏—Ü—ã –∑–∞ –æ—á–∫–∏
    createParticles(40, 40, 5, '#ff4757');

    setTimeout(() => {
      scoreEl.classList.remove('score-animation');
    }, 300);
  }

  // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
  speed += config.speedGrowth * speedMultiplier;
  speedValue.textContent = (speed / 3).toFixed(1) + 'x';

  // –°–∫—Ä–∏–Ω—à–µ–π–∫
  if (screenShake > 0) {
    screenShake--;
  }

  // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Å–∫–æ—Ä–æ—Å—Ç–∏
  if (speed * speedMultiplier > 10) {
    speedWarning.style.display = 'block';
  } else {
    speedWarning.style.display = 'none';
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ü–∞ –∏–≥—Ä—ã
  if (cube.y > GAME_HEIGHT + 100) {
    endGame();
  }
}

function updateCubeTrail() {
  cube.trail.forEach(t => {
    t.life -= 0.05;
  });
  cube.trail = cube.trail.filter(t => t.life > 0);
}

function draw() {
  // –û—á–∏—Å—Ç–∫–∞ —Å —É—á–µ—Ç–æ–º —Å–∫—Ä–∏–Ω—à–µ–π–∫–∞
  let shakeX = screenShake > 0 ? rand(-screenShake, screenShake) : 0;
  let shakeY = screenShake > 0 ? rand(-screenShake/2, screenShake/2) : 0;

  ctx.save();
  ctx.translate(shakeX, shakeY);

  // –¢–µ–º–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
  ctx.fillStyle = '#0a1418';
  ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

  // –≠—Ñ—Ñ–µ–∫—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ (—Ä–∞–∑–º—ã—Ç—ã–µ –ª–∏–Ω–∏–∏)
  if (speed > 5) {
    for (let i = 0; i < 5; i++) {
      ctx.strokeStyle = `rgba(255, 71, 87, ${0.1 - i * 0.02})`;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(-100 + (Date.now() * speed * 0.01) % 200, i * 100);
      ctx.lineTo(GAME_WIDTH + 100, i * 100);
      ctx.stroke();
    }
  }

  // –¢—Ä–µ–π–ª –∫—É–±–∞
  cube.trail.forEach((t, i) => {
    ctx.globalAlpha = t.life * 0.5;
    ctx.fillStyle = cube.color;
    const size = cube.size * (0.5 + i * 0.1);
    ctx.fillRect(
      t.x + (cube.size - size) / 2,
      t.y + (cube.size - size) / 2,
      size,
      size
    );
  });
  ctx.globalAlpha = 1.0;

  // –ß–∞—Å—Ç–∏—Ü—ã
  drawParticles();

  // –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã
  platforms.forEach(p => {
    // –¢–µ–Ω—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.fillRect(p.x + 3, p.y + 3, p.width, p.height);

    // –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞
    ctx.fillStyle = p.color;
    ctx.shadowColor = p.color;
    ctx.shadowBlur = 20;
    ctx.fillRect(p.x, p.y, p.width, p.height);

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞
    ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
    ctx.fillRect(p.x, p.y, p.width, 4);

    // –≠—Ñ—Ñ–µ–∫—Ç –¥–ª—è –¥–≤–∏–∂—É—â–∏—Ö—Å—è –ø–ª–∞—Ç—Ñ–æ—Ä–º
    if (p.moving) {
      ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
      ctx.fillRect(p.x + 5, p.y + 5, 10, p.height - 10);
    }
  });
  ctx.shadowBlur = 0;

  // –ö—É–±
  ctx.fillStyle = cube.color;
  ctx.shadowColor = cube.color;
  ctx.shadowBlur = 25;
  ctx.fillRect(cube.x, cube.y, cube.size, cube.size);

  // –î–µ—Ç–∞–ª–∏ –∫—É–±–∞
  ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
  ctx.fillRect(cube.x + 8, cube.y + 8, cube.size - 16, 10);

  // –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –∫–æ–º–±–æ
  if (combo >= 3) {
    ctx.strokeStyle = '#ffd700';
    ctx.lineWidth = 3;
    ctx.strokeRect(cube.x - 3, cube.y - 3, cube.size + 6, cube.size + 6);
  }

  ctx.shadowBlur = 0;
  ctx.restore();
}

/* ================= GAME FLOW ================= */
function endGame() {
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–∞
  if (score > bestScore) {
    bestScore = score;
    bestEl.textContent = bestScore;
    bestScoreDisplay.textContent = bestScore;
    localStorage.setItem('jumpCubeHardBestScore', bestScore);

    // –≠—Ñ—Ñ–µ–∫—Ç –Ω–æ–≤–æ–≥–æ —Ä–µ–∫–æ—Ä–¥–∞
    for (let i = 0; i < 150; i++) {
      createParticles(GAME_WIDTH / 2, GAME_HEIGHT / 2, 1, '#ffd700');
    }
  }

  showGameOver();
}

function restartGame() {
  gameOver = false;
  paused = false;

  cube.y = groundY - 60;
  cube.vy = 0;
  cube.trail = [];
  cube.color = '#ff4757';
  score = 0;
  combo = 0;
  speed = config.baseSpeed;
  screenShake = 0;

  scoreEl.textContent = '0';
  comboEl.style.display = 'none';
  speedWarning.style.display = 'none';
  pauseMenu.style.display = 'none';
  gameOverMenu.style.display = 'none';

  particles = [];
  initPlatforms();
}

function startNewGame() {
  updateConfig();
  restartGame();
}

/* ================= GAME LOOP ================= */
function gameLoop() {
  update();
  draw();
  requestAnimationFrame(gameLoop);
}

function startGameLoop() {
  requestAnimationFrame(gameLoop);
}

/* ================= UTILITIES ================= */
function rand(min, max) {
  return Math.random() * (max - min) + min;
}

function clamp(v, min, max) {
  return Math.max(min, Math.min(max, v));
}

/* ================= INITIALIZE GAME ================= */
init();
</script>

</body>
</html>
